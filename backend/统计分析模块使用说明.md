# 统计分析与数据展示模块 - 使用说明

## 一、模块概述

统计分析模块为游泳馆管理系统提供全面的数据统计和分析功能，包括会员统计、课程预约统计、入场次数统计和运营情况概览等。

### 核心特性

1. **Redis缓存优化**：使用Redis缓存高频访问的统计数据，减少数据库压力
2. **性别数据排除**：性别统计中自动排除未知性别（gender=0）的数据
3. **权限控制**：所有统计接口仅管理员可访问
4. **自动缓存更新**：相关业务操作（注册、预约、入场）会自动清除对应缓存

## 二、部署步骤

### 2.1 前置条件

- MySQL 8.0+
- Redis 6.0+
- Spring Boot 2.7.6
- 已完成基础模块（用户、课程、预约、入场）的部署

### 2.2 数据库索引创建

为了优化统计查询性能，需要执行索引创建脚本：

```bash
# 执行索引创建脚本
mysql -u root -p swimming_sys < backend/sql/statistics_indexes.sql
```

### 2.3 Redis配置

确保`application.yml`中Redis配置正确：

```yaml
spring:
  redis:
    host: localhost
    port: 6379
    database: 0
```

### 2.4 启动服务

```bash
cd backend
mvn spring-boot:run
```

## 三、API接口文档

所有接口统一前缀：`/api/v1/statistics`

权限要求：所有接口需要管理员权限（role=0）

### 3.1 会员统计接口

#### 3.1.1 获取会员总览统计

```http
GET /api/v1/statistics/member/overview
```

**响应示例：**
```json
{
  "success": true,
  "code": 200,
  "message": "查询成功",
  "data": {
    "totalMembers": 150,
    "activeMemberCount": 145,
    "inactiveMemberCount": 5,
    "activeRate": 96.67,
    "todayNewMembers": 5,
    "weekNewMembers": 20,
    "monthNewMembers": 65
  }
}
```

**缓存策略：** 10分钟

---

#### 3.1.2 获取会员分布统计

```http
GET /api/v1/statistics/member/distribution
```

**响应示例：**
```json
{
  "success": true,
  "code": 200,
  "message": "查询成功",
  "data": {
    "roleDistribution": {
      "adminCount": 3,
      "memberCount": 150,
      "nonMemberCount": 50
    },
    "genderDistribution": {
      "maleCount": 85,
      "femaleCount": 65,
      "maleRate": 56.67,
      "femaleRate": 43.33
    }
  }
}
```

**说明：** 性别分布中排除了gender=0（未知）的用户，百分比基数为男性+女性总数。

**缓存策略：** 10分钟

---

#### 3.1.3 获取会员增长趋势

```http
GET /api/v1/statistics/member/trend?period=month&limit=6
```

**参数说明：**
- `period`：统计周期，当前仅支持`month`（按月）
- `limit`：返回条数，默认6

**响应示例：**
```json
{
  "success": true,
  "code": 200,
  "message": "查询成功",
  "data": [
    {"period": "2025-08", "count": 42},
    {"period": "2025-09", "count": 48},
    {"period": "2025-10", "count": 51},
    {"period": "2025-11", "count": 55},
    {"period": "2025-12", "count": 58},
    {"period": "2026-01", "count": 65}
  ]
}
```

**缓存策略：** 1小时

---

### 3.2 预约统计接口

#### 3.2.1 获取预约总览统计

```http
GET /api/v1/statistics/booking/overview
```

**响应示例：**
```json
{
  "success": true,
  "code": 200,
  "message": "查询成功",
  "data": {
    "totalBookings": 500,
    "activeBookings": 80,
    "completedBookings": 420,
    "cancelledBookings": 80,
    "completionRate": 84.00,
    "cancellationRate": 16.00
  }
}
```

**缓存策略：** 10分钟

---

#### 3.2.2 获取热门课程排行

```http
GET /api/v1/statistics/booking/hot-courses?limit=10
```

**参数说明：**
- `limit`：返回条数，默认10

**响应示例：**
```json
{
  "success": true,
  "code": 200,
  "message": "查询成功",
  "data": [
    {
      "courseId": 1,
      "courseName": "游泳入门班",
      "courseType": "基础班",
      "bookingCount": 120,
      "capacity": 20,
      "currentCount": 18,
      "occupancyRate": 90.00
    },
    {
      "courseId": 2,
      "courseName": "蛙泳提高班",
      "courseType": "提高班",
      "bookingCount": 95,
      "capacity": 15,
      "currentCount": 14,
      "occupancyRate": 93.33
    }
  ]
}
```

**缓存策略：** 30分钟

---

#### 3.2.3 获取预约趋势统计

```http
GET /api/v1/statistics/booking/trend?days=7
```

**参数说明：**
- `days`：统计天数，默认7天

**响应示例：**
```json
{
  "success": true,
  "code": 200,
  "message": "查询成功",
  "data": [
    {"period": "2026-01-13", "count": 12},
    {"period": "2026-01-14", "count": 18},
    {"period": "2026-01-15", "count": 15},
    {"period": "2026-01-16", "count": 20},
    {"period": "2026-01-17", "count": 17},
    {"period": "2026-01-18", "count": 14},
    {"period": "2026-01-19", "count": 16}
  ]
}
```

**缓存策略：** 1小时

---

### 3.3 入场统计接口

#### 3.3.1 获取入场总览统计

```http
GET /api/v1/statistics/entrance/overview
```

**响应示例：**
```json
{
  "success": true,
  "code": 200,
  "message": "查询成功",
  "data": {
    "totalEntrances": 2500,
    "todayEntrances": 45,
    "weekEntrances": 320,
    "monthEntrances": 1350
  }
}
```

**缓存策略：** 10分钟

---

#### 3.3.2 获取入场趋势统计

```http
GET /api/v1/statistics/entrance/trend?days=30
```

**参数说明：**
- `days`：统计天数，默认30天

**响应示例：**
```json
{
  "success": true,
  "code": 200,
  "message": "查询成功",
  "data": [
    {"period": "2025-12-20", "count": 42},
    {"period": "2025-12-21", "count": 38},
    {"period": "2025-12-22", "count": 45},
    ...
  ]
}
```

**缓存策略：** 1小时

---

#### 3.3.3 获取入场时段分布统计

```http
GET /api/v1/statistics/entrance/hourly
```

**响应示例：**
```json
{
  "success": true,
  "code": 200,
  "message": "查询成功",
  "data": [
    {"hour": 6, "entranceCount": 5},
    {"hour": 7, "entranceCount": 12},
    {"hour": 8, "entranceCount": 25},
    {"hour": 9, "entranceCount": 45},
    ...
    {"hour": 18, "entranceCount": 85},
    {"hour": 19, "entranceCount": 92},
    {"hour": 20, "entranceCount": 78}
  ]
}
```

**说明：** 统计近30天的入场时段分布数据

**缓存策略：** 1小时

---

### 3.4 运营概览接口

#### 3.4.1 获取运营情况概览

```http
GET /api/v1/statistics/dashboard
```

**响应示例：**
```json
{
  "success": true,
  "code": 200,
  "message": "查询成功",
  "data": {
    "memberCount": 150,
    "todayNewMembers": 5,
    "todayNewMembersGrowth": "+25.0%",
    "monthBookings": 320,
    "monthBookingsGrowth": "+8.3%",
    "todayEntrances": 45,
    "todayEntrancesGrowth": "+5.2%",
    "courseCount": 25,
    "coachCount": 8
  }
}
```

**说明：** 增长率对比昨日或上月数据计算得出

**缓存策略：** 5分钟

---

## 四、缓存管理

### 4.1 缓存Key设计

```
statistics:member:overview                    # 会员总览
statistics:member:distribution                # 会员分布
statistics:member:trend:6                     # 会员趋势（近6个月）
statistics:booking:overview                   # 预约总览
statistics:booking:hot:top10                  # 热门课程TOP10
statistics:booking:trend:day:7                # 预约趋势（近7天）
statistics:entrance:overview                  # 入场总览
statistics:entrance:trend:day:30              # 入场趋势（近30天）
statistics:entrance:hourly:distribution       # 入场时段分布
statistics:dashboard:overview                 # 运营概览
```

### 4.2 缓存过期策略

| 数据类型 | 过期时间 | 说明 |
|---------|---------|------|
| 运营概览 | 5分钟 | 高频访问页面，实时性要求高 |
| 基础统计 | 10分钟 | 会员、预约、入场总览等 |
| 趋势数据 | 1小时 | 历史趋势数据，变化较慢 |
| 排行数据 | 30分钟 | 热门课程等排行数据 |

### 4.3 自动缓存清除

系统在以下操作时会自动清除相关缓存：

- **用户注册**：清除会员统计缓存、运营概览缓存
- **创建预约**：清除预约统计缓存、运营概览缓存
- **取消预约**：清除预约统计缓存、运营概览缓存
- **入场验证**：清除入场统计缓存、运营概览缓存

### 4.4 手动清除缓存

如需手动清除缓存，可以连接Redis执行：

```bash
# 清除所有统计缓存
redis-cli KEYS "statistics:*" | xargs redis-cli DEL

# 清除特定模块缓存
redis-cli KEYS "statistics:member:*" | xargs redis-cli DEL
redis-cli KEYS "statistics:booking:*" | xargs redis-cli DEL
redis-cli KEYS "statistics:entrance:*" | xargs redis-cli DEL
```

## 五、性能优化

### 5.1 数据库索引

已创建的索引列表：

```sql
-- user表
idx_role_delete_status      # (role, is_delete, status)
idx_role_delete_time        # (role, is_delete, created_time)
idx_role_delete_gender      # (role, is_delete, gender)

-- booking表
idx_course_status_delete    # (course_id, status, is_delete)
idx_time_status_delete      # (booking_time, status, is_delete)
idx_user_status_delete      # (user_id, status, is_delete)

-- entrance_record表
idx_time_delete             # (entrance_time, is_delete)
idx_user_time_delete        # (user_id, entrance_time, is_delete)
idx_booking_delete          # (booking_id, is_delete)

-- course表
idx_type_status_delete      # (course_type, status, is_delete)
idx_coach_delete            # (coach_id, is_delete)
```

### 5.2 查询优化建议

1. **避免全表扫描**：所有统计查询都使用索引覆盖
2. **分页查询**：大数据量时使用分页限制返回结果
3. **定期维护**：定期分析表结构，优化索引
4. **监控慢查询**：开启慢查询日志，监控执行时间

### 5.3 缓存优化建议

1. **合理设置过期时间**：根据数据变化频率调整
2. **避免缓存雪崩**：为不同类型数据设置不同过期时间
3. **缓存预热**：系统启动时预加载常用统计数据
4. **监控缓存命中率**：定期检查Redis命中率

## 六、API测试

### 6.1 使用Swagger测试

访问：`http://localhost:8080/doc.html`

选择"统计分析"标签，即可看到所有统计接口。

### 6.2 使用curl测试

```bash
# 1. 管理员登录获取Token
curl -X POST http://localhost:8080/api/v1/user/login \
  -H "Content-Type: application/json" \
  -d '{"userAccount":"admin","password":"123456"}'

# 2. 获取会员总览统计（替换YOUR_TOKEN）
curl -X GET http://localhost:8080/api/v1/statistics/member/overview \
  -H "Authorization: YOUR_TOKEN"

# 3. 获取运营概览
curl -X GET http://localhost:8080/api/v1/statistics/dashboard \
  -H "Authorization: YOUR_TOKEN"
```

## 七、常见问题

### Q1: 统计数据不准确？

**A:** 检查以下几点：
1. 确认Redis缓存是否过期
2. 手动清除缓存后重新查询
3. 检查数据库中is_delete字段是否正确

### Q2: 性别统计为什么不包含未知？

**A:** 根据需求规格，性别统计中自动排除gender=0的用户，只统计男性（1）和女性（2）。

### Q3: 接口返回401未授权？

**A:** 所有统计接口需要管理员权限，确保：
1. 已登录且Token有效
2. 登录用户的role为0（管理员）

### Q4: Redis连接失败？

**A:** 检查：
1. Redis服务是否启动
2. application.yml中Redis配置是否正确
3. 防火墙是否开放6379端口

### Q5: 统计查询很慢？

**A:** 优化建议：
1. 检查索引是否创建成功
2. 查看MySQL慢查询日志
3. 考虑增加缓存时间
4. 数据量大时考虑分表或归档

## 八、后续扩展建议

1. **数据导出**：支持Excel导出功能
2. **定时报表**：定时生成日报、周报、月报
3. **数据对比**：支持同比、环比数据对比
4. **预警功能**：课程上座率低、会员流失等预警
5. **可视化图表**：前端集成ECharts图表展示
6. **自定义统计**：支持管理员自定义统计维度

## 九、联系方式

如有问题或建议，请联系开发团队。
